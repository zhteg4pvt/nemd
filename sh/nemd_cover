#!/bin/sh
# Under the BSD 3-Clause License by Teng Zhang (zhteg4@gmail.com)
: '
Run coverage analysis and generate report.

Usage:
  nemd_cover source *_test.py
  An empty argument runs module, driver, and workflow unittests.
'
export PYTEST_ADDOPTS='-m ""'
export COVERAGE_RCFILE=$NEMD_SRC/test/unit/.coveragerc

[ -z "$NEMD_SRC" ] && echo "Please source premake" && return 1
for NAME in "module" "driver" "workflow"
  do
    [ $NAME = "module" ] && SUB_DIR=$NAME/nemd || SUB_DIR=$NAME
    set -- coverage run --source=$NEMD_SRC/$SUB_DIR --data-file $NAME -m pytest $NEMD_SRC/test/unit/$NAME/*_test.py
    OUTDIR="$NAME"_out
    "$@" && coverage html --data-file=$NAME -d $OUTDIR && open $OUTDIR/index.html &
  done
wait