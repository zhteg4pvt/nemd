units real
atom_style full
bond_style harmonic
angle_style harmonic
dihedral_style opls
improper_style cvff
special_bonds lj/coul 0 0 0.5
pair_style lj/cut 11.0
pair_modify mix geometric
read_data amorp_bldr.data
dump 1 all xtc 1000 amorp_bldr.xtc
dump_modify 1 unwrap yes
thermo 1000
thermo_modify flush yes
timestep 1.0
min_style fire
minimize 1.0e-6 1.0e-8 1000000 10000000
fix rigid all shake 0.0001 10 10000 b 2 a 1
velocity all create 10 304096062
fix 0a all temp/berendsen 10 10 100
fix 0b all nve
run 1000
unfix 0a
unfix 0b

fix 1a all temp/berendsen 10 300 100
fix 1b all nve
run 50000
unfix 1a
unfix 1b

fix 2a all temp/berendsen 300 300 100
fix 2b all nve
run 50000
unfix 2a
unfix 2b

shell mkdir loop
shell cd loop

variable loop_id loop 0 999 pad
label start_lb
print "loop_id=${loop_id}"
fix 3a all ave/time 1 20 20 c_thermo_press file ${loop_id}
fix 3b all temp/berendsen 300 300 100
fix 3c all nve
run 1000
unfix 3a
unfix 3b
unfix 3c

variable fac python getBdryFac
python getBdryFac input 2 1 ${loop_id} return v_fac format fsf here "from nemd.lmpfunc import getBdryFac"
print "fac=${fac}"
fix 4a all deform 10 x scale ${fac} y scale ${fac} z scale ${fac}
fix 4b all temp/berendsen 300 300 100
fix 4c all nve
run 500
unfix 4a
unfix 4b
unfix 4c

fix 5a all temp/berendsen 300 300 100
fix 5b all nve
run 500
unfix 5a
unfix 5b

if "${fac} == 1" then "jump SELF break_lb"
next loop_id
jump SELF start_lb

label break_lb
variable loop_id delete
variable fac delete

shell cd ..

variable vol equal vol
fix 6a all deform 500 x wiggle $(0.005*v_vol^(1/3)) 25000 y wiggle $(0.005*v_vol^(1/3)) 25000 z wiggle $(0.005*v_vol^(1/3)) 25000
fix 6b all ave/time 1 500 500 c_thermo_press v_vol file loop.wiggle
fix 6c all temp/berendsen 300 300 100
fix 6d all nve
run 100000
unfix 6a
unfix 6b
unfix 6c
unfix 6d

variable imodulus python getModulus
python getModulus input 2 loop.wiggle 50 return v_imodulus format sif here "from nemd.lmpfunc import getModulus"
variable modulus equal ${imodulus}
variable vol delete
variable imodulus delete

fix 7a all press/berendsen iso $(press) 1 1000 modulus ${modulus}
fix 7b all temp/berendsen 300 300 100
fix 7c all nve
run 100000
unfix 7a
unfix 7b
unfix 7c

variable vol equal vol
fix 8a all deform 500 x wiggle $(0.005*v_vol^(1/3)) 25000 y wiggle $(0.005*v_vol^(1/3)) 25000 z wiggle $(0.005*v_vol^(1/3)) 25000
fix 8b all ave/time 1 500 500 c_thermo_press v_vol file npt.wiggle
fix 8c all temp/berendsen 300 300 100
fix 8d all nve
run 100000
unfix 8a
unfix 8b
unfix 8c
unfix 8d

variable imodulus python getModulus
python getModulus input 2 npt.wiggle 50 return v_imodulus format sif here "from nemd.lmpfunc import getModulus"
variable modulus equal ${imodulus}
variable vol delete
variable imodulus delete

fix 9a all press/berendsen iso $(press) 1 1000 modulus ${modulus}
fix 9b all temp/berendsen 300 300 100
fix 9c all nve
run 100000
unfix 9a
unfix 9b
unfix 9c

variable vol equal vol
fix 10a all deform 500 x wiggle $(0.005*v_vol^(1/3)) 25000 y wiggle $(0.005*v_vol^(1/3)) 25000 z wiggle $(0.005*v_vol^(1/3)) 25000
fix 10b all ave/time 1 500 500 c_thermo_press v_vol file final.wiggle
fix 10c all temp/berendsen 300 300 100
fix 10d all nve
run 100000
unfix 10a
unfix 10b
unfix 10c
unfix 10d

variable imodulus python getModulus
python getModulus input 2 final.wiggle 50 return v_imodulus format sif here "from nemd.lmpfunc import getModulus"
variable modulus equal ${imodulus}
variable vol delete
variable imodulus delete

variable xl equal "xhi - xlo"
variable yl equal "yhi - ylo"
variable zl equal "zhi - zlo"
fix 11a all ave/time 1 100000 100000 v_xl v_yl v_zl file xyz
fix 11b all press/berendsen iso 1 1 1000 modulus ${modulus}
fix 11c all temp/berendsen 300 300 100
fix 11d all nve
run 1000000
unfix 11a
unfix 11b
unfix 11c
unfix 11d

print "Final: xl=${xl} yl=${yl} zl=${zl}"
variable ave_x python getXL
python getXL input 1 xyz return v_ave_x format sf here "from nemd.lmpfunc import getXL"
variable ave_y python getYL
python getYL input 1 xyz return v_ave_y format sf here "from nemd.lmpfunc import getYL"
variable ave_z python getZL
python getZL input 1 xyz return v_ave_z format sf here "from nemd.lmpfunc import getZL"
print "Averaged: ave_x=${ave_x} ave_y=${ave_y} ave_z=${ave_z}"
change_box all x scale $(v_ave_x / v_xl) y scale $(v_ave_y / v_yl) z scale $(v_ave_z / v_zl) remap
variable xl delete
variable yl delete
variable zl delete
variable ave_x delete
variable ave_y delete
variable ave_z delete
fix 12a all temp/berendsen 300 300 100
fix 12b all nve
run 10000
unfix 12a
unfix 12b

fix 13a all nve
run 1000000
unfix 13a

write_restart amorp_bldr.rst
