units real
atom_style full
bond_style harmonic
angle_style harmonic
dihedral_style opls
improper_style cvff
special_bonds lj/coul 0 0 0.5
pair_style lj/cut 11.0
pair_modify mix geometric
read_data amorp_bldr.data
dump 1 all xtc 1000 amorp_bldr.xtc
dump_modify 1 unwrap yes
thermo 1000
thermo_modify flush yes
min_style fire
minimize 1.0e-6 1.0e-8 1000000 10000000
timestep 1.0
velocity all create 10 188451765
fix 0a all temp/berendsen 10 10 100
fix 0b all nve
run 1
unfix 0a
unfix 0b

fix 1a all temp/berendsen 10 300 100
fix 1b all nve
run 50
unfix 1a
unfix 1b

fix 2a all temp/berendsen 300 300 100
fix 2b all nve
run 50
unfix 2a
unfix 2b

variable defm_id loop 0 999 pad
label defm_start
print "defm_id=${defm_id}"
shell mkdir defm_${defm_id}
shell cd defm_${defm_id}

variable vol equal vol
variable amp equal 0.01*v_vol^(1/3)
fix 3a all deform 100 x wiggle ${amp} 1000 y wiggle ${amp} 1000 z wiggle ${amp} 1000
fix 3b all ave/time 1 10 10 c_thermo_press v_vol file press_vol
fix 3c all temp/berendsen 300 300 100
fix 3d all nve
run 3000
unfix 3a
unfix 3b
unfix 3c
unfix 3d

variable vol delete
variable amp delete
variable fact python getBdryFact
python getBdryFact input 2 1 press_vol return v_fact format fsf here "from nemd.lmpfunc import getBdryFact"
print "fact=${fact}"
if "${fact} == 1" then "jump SELF defm_break"
fix 4a all deform 100 x scale ${fact} y scale ${fact} z scale ${fact} remap v
fix 4b all temp/berendsen 300 300 100
fix 4c all nve
run 500
unfix 4a
unfix 4b
unfix 4c

variable fact delete
fix 5a all temp/berendsen 300 300 100
fix 5b all nve
run 500
unfix 5a
unfix 5b

shell cd ..
next defm_id
jump SELF defm_start

label defm_break
variable imodulus python getModulus
python getModulus input 2 press_vol 100 return v_imodulus format sif here "from nemd.lmpfunc import getModulus"
variable modulus equal ${imodulus}
variable imodulus delete
variable defm_id delete
shell cd ..
fix 6a all temp/berendsen 300 300 100
fix 6b all nve
run 100
unfix 6a
unfix 6b

variable press equal press
fix 7a all press/berendsen iso ${press} 1 1000 modulus ${modulus}
fix 7b all temp/berendsen 300 300 100
fix 7c all nve
run 100
unfix 7a
unfix 7b
unfix 7c

variable xl equal "xhi - xlo"
variable yl equal "yhi - ylo"
variable zl equal "zhi - zlo"
fix 8a all ave/time 1 100 100 v_xl v_yl v_zl file xyz
fix 8b all press/berendsen iso 1 1 1000 modulus ${modulus}
fix 8c all temp/berendsen 300 300 100
fix 8d all nve
run 1000
unfix 8a
unfix 8b
unfix 8c
unfix 8d

print "Final: xl=${xl} yl=${yl} zl=${zl}"
variable ave_x python getXL
python getXL input 1 xyz return v_ave_x format sf here "from nemd.lmpfunc import getXL"
variable ave_y python getYL
python getYL input 1 xyz return v_ave_y format sf here "from nemd.lmpfunc import getYL"
variable ave_z python getZL
python getZL input 1 xyz return v_ave_z format sf here "from nemd.lmpfunc import getZL"
print "Averaged: ave_x=${ave_x} ave_y=${ave_y} ave_z=${ave_z}"
variable ratio_x equal "v_ave_x / v_xl"
variable ratio_y equal "v_ave_y / v_yl"
variable ratio_z equal "v_ave_z / v_zl"
change_box all x scale ${ratio_x} y scale ${ratio_y} z scale ${ratio_z} remap
variable xl delete
variable yl delete
variable zl delete
variable ave_x delete
variable ave_y delete
variable ave_z delete
variable ratio_x delete
variable ratio_y delete
variable ratio_z delete
fix 9a all temp/berendsen 300 300 100
fix 9b all nve
run 10
unfix 9a
unfix 9b

fix 10a all temp/berendsen 300 300 100
fix 10b all nve
run 5000
unfix 10a
unfix 10b

quit 0
